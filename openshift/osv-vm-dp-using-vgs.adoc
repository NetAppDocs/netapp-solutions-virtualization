---
sidebar: sidebar
permalink: openshift/osv-vm-dp-using-vgs.html
keywords: OpenShift, OCP, Trident, Trident protect, NetApp ONTAP, Red Hat OpenShift, OpenShift Virtualization, CNV, Container Native Virtualization, Red Hat OpenShift Virtualization,Data Protection, Data Management for VMs, VM protection, Volume Group Snapshots
summary: Red Hat OpenShift Virtualization Data Protection with NetApp ONTAP
---
= Protect VMs in Red Hat OpenShift Virtualization using Trident Volume Group Snapshots 
:hardbreaks:
:nofooter:
:icons: font
:linkattrs:
:imagesdir: ../media/

[.lead]
Volume Group Snapshots is a Kubernetes feature that addresses consistency  issues when taking snapshots of multiple PVCs of containers or VMs. This feature allows you to create crash-consistent snapshots of multiple PersistentVolumeClaims (PVCs) simultaneously. This feature is Beta in Kubernetes version v1.32. Trident supports this Beta Feature from Trident version 25.06 onwards. 

To support Volume Group Snapshots feature, Kubernetes introduces three new API objects:

VolumeGroupSnapshotClass: Created by cluster administrators to describe how volume group snapshots should be created.
VolumeGroupSnapshot: Requested by Kubernetes users to create a volume group snapshot for multiple PVCs.
VolumeGroupSnapshotContent: Created by the snapshot controller for dynamically created VolumeGroupSnapshots.

Trident 25.06 automatically detects new CRDs (specified for the Volume Group Snapshot feature) to enable the relevant feature gates in the Trident CSI sidecars. 
NOTE: Trident supports Volume Group Snapshots only for the iSCSI protocol in the 25.06 version.  

Outline of steps to demonstrate the use of VolumeGroupSnapshotclass to create snapshots of a group of volumes/disks of a VM and then restore each disk from the snapshots. 

== Install OpenShift Cluster version: 4.19

* OpenShift version 4.19 uses Kubernetes v1.32 where the Volume Group Snapshot feature is elevated to Beta Status.
* Turn the FeatureGate on for VolumeGroupSnapshots.

.Install OpenShift Cluster
[%collapsible%closed]

====
. Here is the OpenShift Cluster v4.19 installed with Kubernetes v1.32.

image:redhat-openshift-ocpv-vgs-001.png[OpenShift Cluster with K8s V1.32]

Turn the FeatureGate on for VolumeGroupSnapshot by doing the following:

Use the OpenShift web console to navigate to Administration -> Custom Resource Definitions, then search for and click on "FeatureGate". From there, click the "Instances" tab and select the "cluster" instance.

Edit the YAML: Within the YAML tab, edit the FeatureGate/cluster object to include VolumeGroupSnapshot in the enabled list under customNoUpgrade.

image:redhat-openshift-ocpv-vgs-002.png[Enable VolumeGroupSnapshot FeatureGate]

====

== Install Trident version 25.06.1 or later.
* Turn the Feature Gate on for VolumeGroupSnapshots.
* Use node-prep for installing iSCSI tools.

.Install Trident
[%collapsible%closed]

====
image:redhat-openshift-ocpv-vgs-003.png[Install Trident with iscsi nodeprep]

Ensure that the required CRDs for VolumeGroupSnapshots are installed

image:redhat-openshift-ocpv-vgs-004.png[required CRDs available]
====

== Create a Trident iscsi backend, iscsi storage Class and Volume Snapshot class.
* The Volume Group Snapshot feature is supported by Trident only for iscsi protocol in Trident 25.06.
* Make the Storage class and the Volume Snapshot class defaults in the cluster.
* Create the VolumeGroupSnapshotClass

.Create the backend and the storage classes for iSCSI protocol and create a VolumeSnapshotClass Object with the following yaml definitions.
[%collapsible%closed]
====
[source,yaml]
#tbc-iscsi.yaml
apiVersion: v1
kind: Secret
metadata:
  name: tbc-iscsi-secret
type: Opaque
stringData:
  username: admin
  password: <passwd to log into ONTAP ClI>
---
apiVersion: trident.netapp.io/v1
kind: TridentBackendConfig
metadata:
  name: tbc-iscsi
spec:
  version: 1
  storageDriverName: ontap-san
  managementLIF: <mgmt-lif>
  backendName: tbc-iscsi
  svm: openshift
  storagePrefix: openshift-iscsi
  defaults:
    formatOptions: "-E nodiscard"
    nameTemplate: "{{ .config.StoragePrefix }}_{{ .volume.Namespace }}_{{ .volume.RequestName }}"
  credentials:
    name: tbc-iscsi-secret

[source,yaml]
# sc-iscsi.yaml
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: sc-iscsi
provisioner: csi.trident.netapp.io
parameters:
  backendType: "ontap-san"
  provisioningType: "thin"
  fsType: ext4
  snapshots: "true"
reclaimPolicy: "Delete"
allowVolumeExpansion: true

[source,yaml]
# snapshotclass.yaml
apiVersion: snapshot.storage.k8s.io/v1
kind: VolumeSnapshotClass
metadata:
  name: trident-snapshotclass
driver: csi.trident.netapp.io
deletionPolicy: Retain 

image:redhat-openshift-ocpv-vgs-005.png[Stoarge Class and Volume Snapshot lass]
====

== Make the Storage class and the Volume Snapshot class defaults in the cluster

.Set defaults
[%collapsible%closed]
====
[source, cli]
kubectl patch storageclass <storage-class-name> -p '{"metadata": {"annotations":{"storageclass.kubernetes.io/is-default-class":"true"}}}'

[source, cli]
kubectl patch volumesnapshotclass <volumesnapshotclass-name> --type=merge -p '{"metadata":{"annotations":{"snapshot.storage.kubernetes.io/is-default-class":"true"}}}'

NOTE: It is best practice to have both trident storage class and snapshot class set as default so that you take advantage of fast FlexCloning mechanism from snapshots of the golden image when creating new VMs.

====

== Create the VolumeGroupSnapshotClass
.Create VolumeGroupSnapshot class
[%collapsible%closed]
====
[source,cli]
apiVersion: groupsnapshot.storage.k8s.io/v1beta1
kind: VolumeGroupSnapshotClass
metadata:
  name: trident-groupsnapshotclass
  annotations:
    kubernetes.io/description: "Trident group snapshot class"
driver: csi.trident.netapp.io
deletionPolicy: Delete

image:redhat-openshift-ocpv-vgs-006.png[Volume Group Snapshot class]

====

== Install OpenShift Virtualization Operator

* This needs to be done after step 4 so that the golden images are made available as VolumeSnapshots in the cluster using Trident CSI.

.Verify golden images are in volume snapshots
[%collapsible%closed]
====
image:redhat-openshift-ocpv-vgs-007.png[Golden images in volume snapshots]
====

== Create a VM with 3 disks. (root disk and 2 additional disks)
* Add some data into each of the disks

.Create a VM using the default template. Create 2 additional disks using the default storage class for this VM.
[%collapsible%closed]
====
image:redhat-openshift-ocpv-vgs-008.png[VM with 3 PVCs]

Check the corresponding volumes in ONTAP backend.

The root disk volume is a flex-clone volume of the snapshot with the golden image. The other 2 volumes for the 2 disks of the VMs are FlexVol volumes.

Log into the VM using virtctl tool. Format and mount the 2 disks as shown below:
image:redhat-openshift-ocpv-vgs-009.png[VM disks]

====

== Label the PVC(s).
.Label the PVCs using the same key/value and Verify
[%collapsible%closed]
====
[source,cli]
#oc label pvc fedora-vm1 consistencygroup=group1
persistentvolumeclaim/fedora-vm1 labeled
# oc label pvc dv-fedora-vm1-disk1-ulsgg2 consistencygroup=group1
persistentvolumeclaim/dv-fedora-vm1-disk1-ulsgg2 labeled
# oc label pvc dv-fedora-vm1-disk2-86oq76 consistencygroup=group1
persistentvolumeclaim/dv-fedora-vm1-disk2-86oq76 labeled


Check the labels of the PVCs

# oc get pvc fedora-vm1 -o jsonpath='{.metadata.labels.consistencygroup'}
group1
# oc get pvc dv-fedora-vm1-disk1-ulsgg2 -o jsonpath='{.metadata.labels.consistencygroup'}
group1
# oc get pvc dv-fedora-vm1-disk2-86oq76 -o jsonpath='{.metadata.labels.consistencygroup'}
group1
====

9. Create VolumeGroupSnapshots

* Use a label selector to match the labels set on the PVCs.

.create a volumeGroupSnapshot using the following yaml
[%collapsible%closed]
====
[source,yaml]
#vgs.yaml
apiVersion: groupsnapshot.storage.k8s.io/v1beta1
kind: VolumeGroupSnapshot
metadata:
  name: vgs1
spec:
  volumeGroupSnapshotClassName: trident-groupsnapshotclass
  source:
    selector:
      matchLabels:
        consistencygroup: group1 

# oc create -f vgs1.yaml
volumegroupsnapshot.groupsnapshot.storage.k8s.io/vgs1 created

image:redhat-openshift-ocpv-vgs-010.png[VGS created]

A snapshot of all the pvcs with the label key/value pair consistencygroup: group1 will be created. Trident VolumeGroupSnapshots uses ONTAP consistency group in the ONTAP backend.

NOTE: Trident VolumeGroupSnapshots uses ONTAP consistency group(CG) in the ONTAP backend. If you use REST API, a CG is created with all the volumes belonging to the VM (as grouped by the labels), a snapshot of each volume is taken in a consistent way, and then the CG is deleted. You may or may not be able to see the consistency Group being created and deleted in ONTAP, depending on the timing. Below, you can see the consistency group created and then deleted in ONTAP.

image:redhat-openshift-ocpv-vgs-011.png[ONTAP Consistency Group]
====


== Restore the disks of the VM

.Restore the disks of the VM
[%collapsible%closed]
====

Assume that we have lost the sample.txt file from each of the 2 data disks.
image:redhat-openshift-ocpv-vgs-012.png[files lost]

NOTE: Although we created a snapshot of a group of volumes as a single unit, we can only restore from individual snapshot.

Trident provides rapid, in-place volume restoration from a snapshot using the TridentActionSnapshotRestore (TASR) CR. This CR functions as an imperative Kubernetes action and does not persist after the operation completes.

First, stop the VM.

Restore the content of the first disk/PVC with its corresponding snapshot using the yaml as shown below:

[source, yaml]
# cat tasr1.yaml
apiVersion: trident.netapp.io/v1
kind: TridentActionSnapshotRestore
metadata:
  name: trident-snap-disk1
  namespace: default
spec:
  pvcName: dv-fedora-vm1-disk1-ulsgg2
  volumeSnapshotName: snapshot-4d47c9f45423bfca625a0f1b6c5a5ec456ac59d3e583157be919bb7237317c65

# oc create -f tasr1.yaml
tridentactionsnapshotrestore.trident.netapp.io/trident-snap created

Similarly, create another TASR object for the second disk using the PVC and its corresponding snapshot.

[source, yaml]
# cat tasr2.yaml
apiVersion: trident.netapp.io/v1
kind: TridentActionSnapshotRestore
metadata:
  name: trident-snap-disk2
  namespace: default
spec:
  pvcName: dv-fedora-vm1-disk2-86oq76
  volumeSnapshotName: snapshot-afb4c4833460e233c4e86f1108c921b86a6f4d0eb182e99e579081ff6f743f56

# oc create -f tasr2.yaml

Let us make sure that the restore operation is showing succeeded state.

image:redhat-openshift-ocpv-vgs-013.png[TASR succeeded]

Now start the VM, login to it and ensure that the sample.txt file is back on the disks.
image:redhat-openshift-ocpv-vgs-014.png[snapshots restored]

====