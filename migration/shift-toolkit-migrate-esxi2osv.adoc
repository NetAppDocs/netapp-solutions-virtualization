---
sidebar: sidebar
permalink: migration/shift-toolkit-migrate-esxi2osv.html
keywords: netapp, vmware, esxi, vm, migration, openshift, virtualization, redhat, osv
summary: 
---

= Migrate VMs from VMware ESXi to Red Hat OpenShift Virtualization using the Shift Toolkit
:hardbreaks:
:nofooter:
:icons: font
:linkattrs:
:imagesdir: ../media/

[.lead]
Use the Shift Toolkit to migrate VMs between virtualization platforms. The process involves preparing the VMs, converting disk formats, and configuring network settings on the target environment. 

== Migration Prerequisites

=== Red Hat OpenShift Virtualization

* OpenShift Cluster endpoint with following operators installed
** OpenShift Virtualization operator 
** NetApp Trident CSI driver 
** NMstate
* NetApp Trident CSI configured with appropriate backends and storage classes
* NodeNetworkConfigurationPolicy and NetworkAttachmentDefinitions (NAD) configured with proper vLANs
* OpenShift cluster is network reachable
** Update host file entries
* Administrator level privileges on the cluster
** Kubeconfig file downloaded

=== Virtual Machine requirements:
* Ensure the VMDKs are placed on individual volumes (mimicking VMDK to a PVC/PV construct). This needs to be done manually using svmotion.
** This limitation will be removed in the next release where NAS-economy driver can be used for PVC provisioning
* VMware tools should be running on guest VMs for successful VM preparation
* Ensure the VMs that needs to be migrated are in a RUNNING state for preparation
* Shift toolkit performs VM preparation by injecting scripts to:
** Add VirtIO drivers
** Remove VMware tools 
** Backup IP address, routes and DNS information

Note: The virtual machines should be powered OFF before triggering migration
Note: The VMware tools removal happens on the destination hypervisor once the VMs are powered ON

* For invoke-vmscript for preparing the VM, use local administrator for Windows OS and for Linux distros, use a user who has permissions to execute commands without password prompt.
* In case of Windows VMs, mount the virtIO ISO to the VM, otherwise preparation will fail). The VirtIO ISO driver can be downloaded from link:https://fedorapeople.org/groups/virt/virtio-win/direct-downloads/archive-virtio/virtio-win-0.1.271-1/virtio-win-0.1.271.iso[here].  The script will use the drive path and copy the files.
** Ensure the ISO specified in the link is used as the preparation script use .msi package to install the drivers and qemu-guest-agents.

== Set up the destination

Once the pre-requisites are in place, login to Shift toolkit UI and configure the site with OpenShift as the destination hypervisor. To add, click on “Add New Site” and select “Destination”.

*Destination*

image::shift-toolkit-100.png["Image of the select destination user interface"]

* Destination Site Details
** Site Name - Provide a name for the site
** Hypervisor – Select OpenShift as the target
** Site Location – Select the default option
** Connector – Select the default selection

Once filled, click Continue.

image::shift-toolkit-101.png["Image of the destination site details user interface"]

Based on the selection, fill in the necessary details. 

* Destination OpenShift details
** Endpoint - FQDN of OpenShift Cluster endpoint
*** For instance, api.demomigsno.demoval.com
** Upload Kubeconfig file – use the kubeconfig file with minimal permissions

Note: The file extension should be yaml.

image::shift-toolkit-102.png["Image of the destination OpenShift details user interface"]

* Once done, click “Create Site”

Note: The source and destination volume will be the same as the disk format conversion happens at the volume level and within the same volume.

image::shift-toolkit-103.png["Image of the destination OpenShift creation"]

Next step is to group the required VMs into their migration groups as resource groups. 

For detailed steps, refer to the section link:https://docs.netapp.com/us-en/netapp-solutions-virtualization/migration/shift-toolkit-ui.html#resource-groupings[“Resource groupings”].

Note: The VM selection for resource group is based on virtual machine and not at the datastore level.  

To start creating resource groups, click on the “Create New Resource Group” menu item.

. Access Resource groups, click on “Create New Resource Group”.
. On the “New resource group”, select the Source site from the dropdown and click “Create”
. Provide Resource Group Details and select the workflow. The workflow provides two options 
.. Clone based Migration – performs end to end migration of the VM from source hypervisor to destination hypervisor. 
.. Clone based Conversion – Performs conversion of the disk format to the selected hypervisor type. 
. Click on “Continue”
. Select appropriate VMs using the search option.
+
Note: Move the VM VMDKs to convert or migrate to a designated individual datastore volumes on a newly created ONTAP SVM before conversion. 
+
Note: The virtual machine will show all the datastores associated with it. 
+
image::shift-toolkit-104.png["Image of the datastores associated with the virtual machine"]
+
image::shift-toolkit-105.png["Image of the datastores associated with the virtual machine"]

. Update the migration details by selecting “Destination Site”, “Destination OpenShift entry” and select the storage class
+
image::shift-toolkit-106.png["Image of the migration details user interface"]
+
Note: The trident backend will be mapped to the source volume automatically if there is only one TBC, however if there are multiple TBCs, the backend can be selected. 
+
Note: Ensure to select the Boot Order and Boot delay (secs) for all the selected VMs. Set the order of power on sequence by selecting each virtual machine and setting up the priority for it. 3 is the default value for all virtual machines.

. Click on “Create Resource Group”.
+
image::shift-toolkit-107.png["Image of the migration details configuration"]

== Blueprints

To migrate or convert virtual machines, a plan is necessary. This involves:

* Selecting the Source and Destination OpenShift from the dropdown menus.
* Choosing Resource Groups to include in the blueprint.
* Defining Application Power-On Order, such as:
* Domain Controllers
* Tier-1 Applications
* Tier-2 Applications

To create the blueprint, navigate to the “Blueprints” tab and click on “Create New Blueprint”. 

. Access Blueprints, click on “Create New Blueprint”.
. On the “New Blueprint”, provide a name for plan and add necessary host mappings by selecting Source Site > associated vCenter, Destination Site and the associated OpenShift target.  
. Once mappings are done, select the cluster and host mapping.
+
image::shift-toolkit-108.png["Image of the blueprint details user interface"]

. Select Resource Group Details and click on “Continue”
. Set Execution Order for Resource Group. This option enables to select the sequence of operations when multiple resource groups exist. 
. Once done, select Network Mapping to the appropriate logical networks.  The Network attachment definitions should already be provisioned within OpenShift cluster with the appropriate VLAN and trunk options.
+
image::shift-toolkit-109.png["Image of the network mapping user interface"]
+
Note: For test migration, “Do no configure Network” is the default selection and Shift toolkit does not perform IP address assignment. Once the disk is converted and virtual machine is bought on OpenShift side, manually assign the bubble logical network to avoid any colliding with production network.

. Based on the selection of VMs, storage class and backend mappings will be automatically selected.
+
Note: Make sure the VMDKs are svmotioned to individual volumes beforehand so the virtual machine can be created and powered ON from the PVC.

. Under VM details, select configuration details, provide service account and valid user credentials for each OS type. This is used to connect to the virtual machine to create and run scripts that are necessary for adding VirtIO drivers, removing VMware tools and backing up IP configuration details.
.. For Windows based OS, it is recommended to use a user with local administrator privileges. Domain credential can also be used. 
.. In case of Linux distro-based guest VMs, provide a user that can execute sudo commands without password meaning the user should be part of the sudoers list or added as a new configuration file to the /etc/sudoers.d/ folder.
+
image::shift-toolkit-110.png["Image of the configuration selection user interface"]
+
Note: The Configuration selection allows to select the disk image format, skip override prepareVM and choose whether to split the volume from the parent. By default, split clone is disabled.  In case of disk image format, the workflow defaults to RAW. The override prepareVM allows to skip the preparation of the VM, which allows administrators to run homegrown scripts to make the VM ready for migration. If selected, Shift toolkit will not inject any scripts or add the VirtIO drivers.

. Again under VM details, select the relevant IP config option. By default, “Do not configure” is selected. 
.. To migrate VMs with the same IPs from the source system, select “Retain IP”. 
.. To migrate VMs using static IPs in the source system and to assign DHCP on the target VMs, then select “DHCP”.
+
Make sure the following requirements are met for this functionality to work:
+
.. Ensure the VMs are powered on during the prepareVM phase and up to the scheduled migration time.
.. For VMware VMs, ensure that VMware Tools are installed.
.. Ensure the preparation script is run on the source VM by an account with administrator privileges on windows OS and with sudo privileges with no password option on Linux based distro OS to create cron jobs.

. The next step is VM configuration. 
.. Optionally resize the VMs CPU/RAM parameters which can be very helpful for resizing purposes. 
.. Boot Order override: Also modify the Boot Order and Boot delay (secs) for all the selected VMs across the resource groups. This is an additional option to modify the boot order if any changes required from what was selected during Resource group boot order selection. By default, the boot order selected during resource group selection is used, however any modifications can be done at this stage. 
.. Power ON: Uncheck this option if workflow should not power ON the virtual machine. Default option is ON meaning the VM will be powered ON.
.. Remove VMware tools: Shift toolkit removes VMware tools after the conversion. This option is selected by default. This can be unselected if the plan is to execute customer’s own customized scripts.
.. VM Firmware: Shift toolkit uses the following rule of thumb and defaults to the appropriate one- BIOS > BIOS and EFI > EFI. No selection is possible for this option.
.. Retain MAC: The MAC address of the respective VMs can be retained to overcome licensing challenges for those applications relying on MAC. 
Note: If interface name needs to be retained while retaining the MAC address, ensure appropriate udev rules are created on the source vm.
.. Service Account override: This option allows to specify a separate service account if the global one cannot be used.

. Click “Continue”.
. In the next step, schedule the migration by selecting the checkbox to set the date and time. Make sure all the virtual machines (VMs) are prepared and powered off before the scheduled date. Once done, click on “Create Blueprint”.
+
Note: While scheduling, choose a date that is at least 30 minutes ahead of the current Shift VM time. This is to ensure the workflow gets enough time to prepare the VMs within the resource group.
+
. Once the blueprint is created, a prepareVM job is initiated and it automatically runs scripts on the source VMs to prepare them for migration
+
image::shift-toolkit-111.png["Image of the virtual machines prepared for migration"]
+
For detailed information on preparation steps, refer to link:https://docs.netapp.com/us-en/netapp-solutions-virtualization/migration/shift-toolkit-ui.html#blueprints[Blueprints] section
+
The workflow injects the scripts to update virtIO driver, qemu-agent installation, remove VMware tools, backup IP details and fstab updates. The script utilizes PowerCLI to connect to guest VMs (Linux or Windows) and updates the VirtIO drivers, ensuring the required drivers are present when the VM boots on the OpenShift Cluster.
+
* On Windows-based operating systems, the default location for storing preparation scripts is the C:\NetApp folder.
* On Linux-based virtual machines, the default locations are the /NetApp directory and the /opt directory.
+
Note: For any supported VM OSes, Shift toolkit is intelligent to automatically install the necessary VirtIO drivers. These drivers must be present in the source VM before the disk conversion to ensure the VM can boot successfully after the conversion.
+
Once the prepareVM job completes successfully (as shown in the screenshot below), the VMs are ready for migration, and the blueprint status will update to "PrepareVM Complete."
+
image::shift-toolkit-112.png["Image of the virtual machines prepared for migration"]
+
Migration will now happen at the set time or can be started manually by clicking on Migrate option.
+
image::shift-toolkit-113.png["Image of the virtual machines prepared for migration"]

== Migration

Once the blueprint is created, the "Migrate" option can be initiated. During this process, the Shift Toolkit executes a series of operations to convert the disk format and then uses the converted disk to provision virtual machines on the designated OLVM host, as specified in the blueprint.

The high-level steps performed are as follows:

Pre-requisite – The VMs must be turned OFF gracefully as per the planned maintenance time. 

* Delete existing snapshots for all VMs in the blueprint 
* Trigger VM snapshots for Blueprint – at source
* Trigger volume snapshot before disk conversion
* Clone the individual volumes
* Convert VMDK to RAW format for each VMDK
* Clean up the volumes to have just the disk.img file
* Import the volumes as PVCs using Trident import
* Create VMs using VM specific yaml file
* Power ON VMs in protection group – at target
* Register the networks on each VM
* Remove VMware tools and assign the IP addresses using cron job depending on the OS type

image::shift-toolkit-114.png["Image of the migration steps user interface"]

=== Workflow - deep dive

Once the pre-reqs are met and the blueprint mappings are created, simply execute migration which will do the orchestration.

Below sections cover what steps are triggered by Shift toolkit to convert the VMDK and create VMs on the OpenShift cluster.

==== Convert VMDK

Shift toolkit will automatically find the VMDKs associated with each VM including the primary boot disk. 

Note: If there are multiple VMDK files, each VMDK will be converted. 

Note: In this release (v4.0), each VMDK should be placed on individual volume/datastore.

==== Import the RAW image using NetApp Trident

With the virtual machine disk image converted to RAW format, Shift toolkit cleans up the volumes and renames the raw file to disk img and assigns necessary permissions on the file. 

Once done, the volumes are imported as PVCs using NetApp Trident APIs.

==== Create Virtual Machine

Once the PVCs are imported and PVs are in place, Shift toolkit uses OC CLI to create each VM depending on the OS using the yaml files. 

Note: VMs will be created under “Default” namespace. 

==== Booting VM for the first time

Depending on the Virtual Machine OS, and Shift toolkit will auto assign the VM boot option, along with the storage controller interfaces.  In case of Linux distros, VirtIO or VirtIO scsi is used. And for Windows, the VM is powered ON with SATA interface and then the scheduled script auto installs VirtIO drivers and then change the interface to VirtIO. The networks are assigned accordingly based on the selection.
 
image::shift-toolkit-115.png["Image of the Red Hat OpenShift VM migration user interface"]

== Using Integration with Migration toolkit for virtualization

This section covers how Migration toolkit for virtualization (MTV) and NetApp Shift Toolkit brings seamless migration experience to Red Hat OpenShift Virtualization and provides a step-by-step guide on transitioning to OpenShift Virtualization using Migration toolkit for virtualization and Shift Toolkit’s conversion APIs. 

=== Prerequisites

* OpenShift cluster with OpenShift Virtualization operator and NetApp Trident CSI driver installed.
* MTV 2.9.4 (which includes the conversion mode)
* link:https://mysupport.netapp.com/site/tools/tool-eula/netapp-shift-toolkit/download[Shift toolkit] installed
** No additional configuration required. Since only Shift toolkit API is used in this case, there is no need to configure Shift toolkit resource groups or blueprints.
* Administrator level privileges on the OpenShift cluster 
* A linux instance with tridentctl and OC command line tool installed. 
** kubeconfig exported or OC login shd be executed to connect to the cluster.
** Download the script named - OpenShift-MTV from Shift toolkit UI
*** Access Settings > Developer Access > Script Blocker and download the script
** Unzip the zip using unzip <filename> (unzip ' openshift-mtv.zip')
** Ensure Python3 is installed (dnf install python3)
** Install openjdk 8 or later version (yum install java-1.8.0-openjdk)
** Run pip install -r requirements.txt (needs internet)

==== Virtual Machine requirements

* Ensure the VMDKs for a VM are placed on individual volumes. For instance, consider a VM with 3 disks. Each of the disk should be placed on its individual volume (mapping datastore to PVC construct). This needs to be done manually using storage vmotion.

=== Create Migration plans using MTV via web console or the command line 

To leverage the lighting fast conversion of VMDK files, first step is to create a migration plan for the VM/s and ensure the following parameters are updated in the YAML:

* targetNamespace: default
* type: conversion
* storage: {}

Note: The plan should be created beforehand to ensure the preserve IP settings are configured by MTV.

=== Mapping the VMs from vCenter and volumes on ONTAP storage with MTV

To start the process, leverage the script to create the necessary PVCs and import them to the OpenShift cluster. The PVCs should have following labels and annotations:

* Labels:
* The vmID and vmUUID in the PVC.
+
Note: Forklift will look for the vmID and vmUUID in the PVC

* Annotation:
* The vmdk disk name
+
Note: Forklift will use the disk name (VMDK path) for forklift.konveyor.io/disk-source

Every PVC generated should have these attributes set. The script ensures the same is added for every PVC and also updates the permissions of disk.img with the following:

* "owner": { "id": 107 },
* "group": { "id": 107 },
* "mode": "0655"

To get started, update the json file with the following details:

* ONTAP Cluster
** This can be a SVM and vsadmin can be used
** Splitclone parameter can be set to “False” if the clone volume doesn’t need to be detached immediately.

* vCenter 
** Min RBAC rights to access the vCenter to discover the VMs and associated VMDK files.
* Trident storage class 
** Should be NFS backend and ensure the right version is updated in the yaml
* OpenShift
** Specify the project name (default is used as an example)

Note: Keep the rest of the values as default

=== High level workflow:

Once the pre-reqs are met, simply execute python3 main.py which will create the PVCs and import them to the OpenShift Cluster. Once the PVCs are imported, trigger migration using MTV, which will create the VM with the appropriate specification specified within the YAML.

image::shift-toolkit-116.png["Image showing the execution of the python script"]

image::shift-toolkit-117.png["Image showing the results in the Shift Toolkit after running the python script"]

==== Deep Dive

Below sections cover what steps are triggered by Shift toolkit APIs and MTV to convert the VMDK ad create a VM on the OpenShift side.

===== Convert VMDK

Once the json file is updated, the script will automatically find the VMDKs associated with each VM including the primary boot disk. 

Note: if there are multiple VMDK files, each VMDK will be converted. 

===== Upload the RAW image to OpenShift Virtualization Cluster

The script uses Trident CSI to import the volumes as PVCs to the cluster. The PVC yaml will be populated with labels and annotations. 

===== Create Virtual Machine

Once done, call MTV plan to start the migration. The UI will show as Cold, however based on the yaml specification of conversion, MTV will check for each PVC and the vmid/vmUUID and map them and initialize the migration. 

image::shift-toolkit-118.png["Image showing the migration status"]

Note: VMs are created under “Default” project for virtual machines, however it can be modified within the MTV migration plan YAML. 

===== Booting VM for the first time

Depending on the Virtual Machine OS, MTV will auto assign the VM boot option, along with the storage controller interfaces. 

All of the above is covered by running python3 main.py and then calling MTV to start the migration.

image::shift-toolkit-119.png["Image showing the migration history"]

Migration completed in 6 mins. This VM has 1.5TB data disk (spread across 3 PVCs). This showcases a streamlined, low-impact approach to re-homing VMs using ONTAP storage. 

Note: Before getting started with this specific integration, please contact your Redhat account team.
