---
sidebar: sidebar
permalink: migration/shift-toolkit-migrate-esxi2hyperv.html
keywords: netapp, vmware, esxi, vm, migration, virtualization, hyper-v, microsoft
summary: "Migrate VMs from VMware ESXi to Microsoft Hyper-V using the Shift Toolkit by preparing VMs, converting disk formats, and configuring the target environment."
---

= Migrate VMs from VMware ESXi to Microsoft Hyper-V using the Shift Toolkit
:hardbreaks:
:nofooter:
:icons: font
:linkattrs:
:imagesdir: ../media/

[.lead]
Migrate VMs from VMware ESXi to Microsoft Hyper-V using the Shift Toolkit by preparing VMs, converting disk formats, and configuring the target environment.

The Shift Toolkit enables VM migration between virtualization platforms through disk format conversion and network reconfiguration on the destination environment.

== Before you begin

Verify that the following prerequisites are met before starting the migration.

.Hyper-V requirements

* Hyper-V hosts configured as standalone hosts or failover cluster
* Hyper-V user account with administrator privileges
* Hyper-V hosts are network reachable with up-to-date DNS entries
* Virtual switches configured with appropriate trunking
* Virtual switch type "External" for network selection
* NFS share (for VMs to be converted) and destination share (for converted VMs) on the same volume
* SMB Constrained Delegation configured using `Enable-SmbDelegation` to avoid access denied errors
* SMB 3.0 enabled (default)
* Continuously available property enabled for SMB shares
* Export policies for SMB disabled on the storage virtual machine (SVM)
+
NOTE: SCVMM is not a supported endpoint for migration in the current release.
+
* The Hyper-V FCI and host discovery relies on DNS resolution. Ensure hostnames are resolvable from Shift Toolkit VM. If resolution fails, update the host file (`C:\Windows\System32\drivers\etc\hosts`) and retry the discovery operation.

.VMware requirements

* VM VMDKs are placed on NFSv3 volume (all VMDKs for a given VM should be part of the same volume)
* VMware tools are running on guest VMs
* VMs to be migrated are in a RUNNING state for preparation
* VMs must be powered off before triggering migration
* VMware tools removal happens on the destination hypervisor once VMs are powered on

.Guest VM requirements

* For Windows VMs: Use local administrator credentials (domain credentials can also be used, however ensure a user profile exists on the VM before conversion)
* For Linux VMs: Use a user with permissions to execute sudo commands without password prompt (user should be part of the sudoers list or added to `/etc/sudoers.d/` folder)

== Step 1: Add the destination site (Hyper-V)

Add the destination Hyper-V environment to the Shift Toolkit.

.Steps

. Click *Add New Site* and select *Destination*.
+
.Show example
[%collapsible]
====
image::shift-toolkit-307.png[Add destination site]
====

. Enter the destination site details:
+
* *Site Name*: Provide a name for the site
* *Hypervisor*: Select Hyper-V as the target
* *Site Location*: Select the default option
* *Connector*: Select the default selection

. Click *Continue*.
+
.Show example
[%collapsible]
====
image::shift-toolkit-308.png[Destination site details]
====

. Enter the destination Hyper-V details:
+
* *Hyper-V Standalone or failover cluster manager*: IP address or FQDN
* *Username*: Username to access (in UPN format: username@domain.com or domain\administrator)
* *Password*: Password to access Hyper-V host or FCI instance for performing inventory of the resources

. Select *Accept Self signed certificate* and click *Continue*.
+
.Show example
[%collapsible]
====
image::shift-toolkit-309.png[Hyper-V details]
====

. Click *Create Site*.
+
.Show example
[%collapsible]
====
image::shift-toolkit-310.png[Create Site]
====
+
NOTE: The source and destination storage system should be the same as the disk format conversion happens at the volume level and within the same volume.

== Step 2: Create resource groups

Organize VMs into resource groups to preserve boot order and boot delay configurations.

.Before you begin

* Ensure qtrees are provisioned as specified in the prerequisites
* Move VMs to a designated datastore on a newly created ONTAP SVM before conversion to isolate production NFS datastores from the staging area

.Steps

. Navigate to *Resource Groups* and click *Create New Resource Group*.
+
.Show example
[%collapsible]
====
image::shift-toolkit-311.png[Create New Resource Group]
====

. Select the *Source site* from the dropdown and click *Create*.

. Provide resource group details and select the workflow:
+
* *Clone based Migration*: Performs end-to-end migration from source to destination hypervisor
* *Clone based Conversion*: Converts disk format to the selected hypervisor type
+
.Show example
[%collapsible]
====
image::shift-toolkit-312.png[Resource group details]
====

. Click *Continue*.

. Select VMs using the search option (default filter is "Datastore").
+
NOTE: The datastore dropdown only shows NFSv3 datastores. NFSv4 datastores are not displayed.
+
.Show example
[%collapsible]
====
image::shift-toolkit-313.png[VM selection]
====
+
.Show example
[%collapsible]
====
image::shift-toolkit-314.png[Datastore filter]
====

. Update migration details:
+
* Select *Destination Site*
* Select *Destination Hyper-V entry*
* Configure Datastore to Qtree mapping
+
.Show example
[%collapsible]
====
image::shift-toolkit-315.png[Migration details]
====
+
.Show example
[%collapsible]
====
image::shift-toolkit-316.png[Qtree mapping]
====
+
NOTE: Ensure the destination path (where the converted VMs are stored) is set to a qtree when converting VMs from ESXi to Hyper-V. Multiple qtrees can be created and used for storing converted VM disks.

. Configure boot order and boot delay for all selected VMs:
+
* *1*: First VM to power on
* *3*: Default
* *5*: Last VM to power on
+
.Show example
[%collapsible]
====
image::shift-toolkit-317.png[Boot order configuration]
====

. Click *Create Resource Group*.
+
.Show example
[%collapsible]
====
image::shift-toolkit-318.png[Create Resource Group]
====

.Result

The resource group is created and ready for blueprint configuration.

== Step 3: Create a migration blueprint

Create a blueprint to define the migration plan, including platform mappings, network configuration, and VM settings.

.Steps

. Navigate to *Blueprints* and click *Create New Blueprint*.
+
.Show example
[%collapsible]
====
image::shift-toolkit-319.png[Create New Blueprint]
====

. Provide a name for the blueprint and configure host mappings:
+
* Select *Source Site* and associated vCenter
* Select *Destination Site* and associated Hyper-V target
* Configure cluster and host mapping
+
.Show example
[%collapsible]
====
image::shift-toolkit-320.png[Host mappings]
====

. Select resource group details and click *Continue*.
+
.Show example
[%collapsible]
====
image::shift-toolkit-321.png[Resource Group Details]
====

. Set execution order for resource groups if multiple groups exist.

. Configure network mapping to appropriate virtual switches.
+
NOTE: Virtual switches should already be provisioned within Hyper-V. On Hyper-V side, the virtual switch type "External" is the only supported option for network selection. For test migration, select "Do not configure Network" to avoid production network conflicts; manually assign network settings after conversion.
+
.Show example
[%collapsible]
====
image::shift-toolkit-322.png[Network mapping]
====
+
.Show example
[%collapsible]
====
image::shift-toolkit-323.png[Network configuration options]
====

. Review storage mappings (automatically selected based on VM selection).
+
NOTE: Ensure the qtree is provisioned beforehand and necessary permissions are assigned so the virtual machine can be created and powered on from SMB share.

. Configure the prepareVM override option if needed. This option is useful when you need to skip VM preparation by the Shift Toolkit and instead perform those tasks using custom scripts. It also enables customization of the IP address to meet specific environment requirements.
+
.Show example
[%collapsible]
====
image::shift-toolkit-324.png[PrepareVM override]
====

. Under VM details, select configuration details and provide service account credentials for each OS type:
+
* *Windows*: Use a user with local administrator privileges (domain credentials can also be used, however ensure a user profile exists on the VM before conversion)
* *Linux*: Use a user that can execute sudo commands without password prompt (user should be part of the sudoers list or added to `/etc/sudoers.d/` folder)
+
.Show example
[%collapsible]
====
image::shift-toolkit-325.png[VM credentials]
====

. Configure IP settings:
+
* *Do not configure*: Default option
* *Retain IP*: Keep same IPs from source system
* *DHCP*: Assign DHCP on target VMs
+
Ensure VMs are powered on during prepareVM phase, VMware Tools are installed, and preparation scripts run with proper privileges.

. Configure VM settings:
+
* Resize CPU/RAM parameters (optional)
* Modify boot order and boot delay
* *Power ON*: Select to power on VMs after migration (default: ON)
* *Remove VMware tools*: Remove VMware Tools after conversion (default: selected)
* *VM Firmware*: Gen1 > BIOS and Gen2 > EFI (automatic)
* *Retain MAC*: Keep MAC addresses for licensing requirements
* *Service Account override*: Specify separate service account if needed
* *VLAN override*: Select correct tagged VLAN name when target hypervisor uses different vLAN name
+
.Show example
[%collapsible]
====
image::shift-toolkit-326.png[VM configuration]
====

. Click *Continue*.

. Schedule the migration by selecting a date and time.
+
NOTE: Schedule migrations at least 30 minutes ahead to allow time for VM preparation.
+
.Show example
[%collapsible]
====
image::shift-toolkit-327.png[Schedule migration]
====

. Click *Create Blueprint*.

.Result

The Shift Toolkit initiates a prepareVM job that runs scripts on source VMs to prepare them for migration.

.Show example
[%collapsible]
====
image::shift-toolkit-328.png[PrepareVM job]
====

The preparation process:

* Injects scripts to add drivers (RHEL/CentOS, Alma Linux), remove VMware tools, and backup IP/route/DNS information
* Uses invoke-VMScript to connect to guest VMs and execute preparation tasks
* For Windows VMs: Stores scripts in `C:\NetApp`
* For Linux VMs: Stores scripts in `/NetApp` and `/opt`

.Show example
[%collapsible]
====
image::shift-toolkit-329.png[Windows preparation scripts]
====

.Show example
[%collapsible]
====
image::shift-toolkit-330.png[Linux preparation scripts]
====

NOTE: For Linux source VMs running CentOS or Red Hat, Shift Toolkit automatically installs necessary Hyper-V drivers before disk conversion to ensure successful boot after conversion. For detailed information, refer to link:https://access.redhat.com/solutions/3465011[System stuck in dracut after the migration of a RHEL VM to hyper-v].

When prepareVM completes successfully, the blueprint status updates to "Active." Migration will now happen at the scheduled time or can be started manually by clicking the *Migrate* option.

.Show example
[%collapsible]
====
image::shift-toolkit-331.png[PrepareVM complete]
====

.Show example
[%collapsible]
====
image::shift-toolkit-332.png[Active blueprint]
====

== Step 4: Execute the migration

Trigger the migration workflow to convert VMs from VMware ESXi to Microsoft Hyper-V.

.Before you begin

* All VMs are gracefully powered off according to the planned maintenance schedule
* Ensure the Shift VM is part of the domain
* Ensure CIFS share is configured with appropriate permissions
* The qtree used for migration or conversion has the right security style
* As a quick test, try creating a VM using Hyper-V Manager from any Hyper-V host within the cluster and place the VHDX on the CIFS share

.Steps

. On the blueprint, click *Migrate*.
+
.Show example
[%collapsible]
====
image::shift-toolkit-333.png[Migrate option]
====

. If VMs are not powered off, the Shift Toolkit will prompt for a graceful shutdown before proceeding.
+
.Show example
[%collapsible]
====
image::shift-toolkit-334.png[Shutdown prompt]
====

. The Shift Toolkit takes the following actions:
+
* Deletes existing snapshots for all VMs in the blueprint
* Triggers VM snapshots at the source
* Triggers volume snapshot before disk conversion
* Converts VMDK to VHDx format for all VMs
+
The conversion happens in seconds, making this the fastest migration approach and reducing VM downtime.
+
.Show example
[%collapsible]
====
image::shift-toolkit-335.png[Migration in progress]
====
+
.Show example
[%collapsible]
====
image::shift-toolkit-336.png[Conversion progress]
====

* Powers on VMs at the target
* Registers networks on each VM
* Removes VMware tools and assigns IP addresses using trigger scripts or cron jobs

.Result

When the job completes, the blueprint status changes to "Migration Complete."

.Show example
[%collapsible]
====
image::shift-toolkit-337.png[Migration complete]
====

.Show example
[%collapsible]
====
image::shift-toolkit-338.png[VMs in Hyper-V Manager]
====

.Show example
[%collapsible]
====
image::shift-toolkit-339.png[VM details in Hyper-V]
====

NOTE: No more than ten conversions should be triggered in parallel from the same ESXi source to the same Hyper-V destination.

NOTE: If there are failures, link:https://learn.microsoft.com/en-us/windows-server/virtualization/hyper-v/manage/remotely-manage-hyper-v-hosts[enable delegation using any authentication protocol].

NOTE: After migration when Windows VMs are powered on, Shift Toolkit uses PowerShell Direct to connect to Windows-based guest VMs regardless of network configuration or remote management settings.

NOTE: After conversion, all VM disks on Windows OS except the OS disk will be offline because the NewDiskPolicy parameter is set to offlineALL on VMware VMs by default. Run this PowerShell command to fix: `Set-StorageSetting -NewDiskPolicy OnlineAll`

NOTE: Shift Toolkit uses cron jobs that execute on boot for Linux-based distributions. No SSH connections are created for Linux-based VMs once they are brought on Hyper-V hosts.

== Video demonstration

The following video demonstrates the process outlined in this solution.

video::f191dd7d-e4e4-4e5a-9654-b26400f3e9c4[panopto, title="Migrate VMs from ESXi to Hyper-V using Shift Toolkit", width=360]