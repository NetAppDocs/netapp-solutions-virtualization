---
sidebar: sidebar
permalink: proxmox/proxmox-wkld-dp-pbs.html
keywords: netapp, proxmox, proxmox ve, all-flash, nfs, iscsi, nvme, fc, ontap, storage, aff, asa, virtual machines, vm, containers, proxmox backup server
summary: In a mixed storage environments, Proxmox Backup Server provides efficient and reliable backup solutions.
---
= Proxmox VE Workload Data Protection with Proxmox Backup Server and NetApp ONTAP
:hardbreaks:
:nofooter:
:icons: font
:linkattrs:
:imagesdir: ../media/

[.lead]
This document outlines the architecture, deployment, and validation of a Proxmox VE workload data protection solution using Proxmox Backup Server (PBS) integrated with NetApp ONTAP storage. It provides guidance on best practices for configuration, performance optimization, and management of the integrated solution.

== Solution Architecture
The solution architecture consists of the following key components:
* Proxmox VE Cluster: A cluster of Proxmox VE nodes that provide virtualization capabilities and manage virtual machines (VMs) and containers.
* Proxmox Backup Server: A dedicated backup solution for Proxmox VE that integrates with ONTAP storage for efficient data protection for workloads running on other storage systems.
* NetApp ONTAP Storage: A high-performance, scalable storage system that provides shared storage for the Proxmox VE cluster and backup storage for PBS.
* Network Infrastructure: A robust network setup that ensures low-latency and high-throughput connectivity between Proxmox VE nodes, PBS, and ONTAP storage.
* NetApp Console: A centralized management interface for managing multiple NetApp storage systems and data services.

Here is the high-level architecture diagram of Proxmox Backup Server setup with ONTAP storage:

image::proxmox-wkld-dp-pbs-001.png[Proxmox VE Workload Data Protection with PBS and NetApp ONTAP Architecture]

== Proxmox Backup Server overview

Proxmox Backup Server (PBS) is an enterprise backup solution designed specifically for Proxmox Virtual Environment (VE). It provides efficient and reliable backup and restore capabilities for VMs and containers running on Proxmox VE hosts. PBS supports features like incremental backups, deduplication, compression, and encryption to optimize storage usage and ensure data security. It also offers flexible backup scheduling and retention policies to meet diverse data protection requirements.

Proxmox Backup Server can be deployed on bare metal or as a VM on Proxmox VE. One of the major concerns with deploying PBS as a VM is the availability of the backup server when the Proxmox VE host is down. To mitigate this risk, it is recommended to deploy PBS on bare metal or on a separate Proxmox VE host or cluster. This ensures that the backup server remains operational even if the primary Proxmox VE host experiences downtime.

As most of the backup contents are self contained in the datastore, it is possible to move the datastore to another PBS instance in case of a failure. This provides flexibility and ensures that backup data remains accessible even if the original PBS instance is unavailable.

Proxmox Backup Server supports various storage backends, including local storage, NFS, iSCSI, FC,  NVMe-oF and now with S3 as Tech Preview. By integrating PBS with NetApp ONTAP storage, organizations can leverage ONTAP's advanced data management features to enhance data protection and recovery capabilities.

Utilizing ONTAP SnapMirror, it is possible to replicate the PBS datastore to another ONTAP system for disaster recovery purposes. This ensures that backup data is protected and can be restored in case of a site failure.

A single PBS instance can manage multiple Proxmox VE clusters, providing a centralized backup solution for large-scale Proxmox VE deployments. Namespaces can be used to logically separate backup data for different clusters or tenants, ensuring data isolation and security. Data retention policies can be configured to automatically manage the lifecycle of backup data, ensuring compliance with organizational data retention requirements.

Prunning policies can be set up to automatically mark to delete old or unnecessary backup data and ensuring that only relevant data is retained. Garbage collection processes help to reclaim storage space by removing unused or obsolete data from the datastore.

Proxmox Backup Server management can be performed through a web-based interface, command-line tools, or REST API, providing flexibility and ease of use for administrators. Web interface is available at port 8007. To access, use the URL https://<pbs-ip-address>:8007.

== Datastore configuration with ONTAP File or Block storage

Proxmox Backup Server can utilize any folder mounted on local storage as a datastore. PBS stores catalog, index and chunk files in the datastore. For better performance and scalability, it is recommended to use NetApp ONTAP  SAN (iSCSI/FC/NVMe-oF), S3 or NFS (with nConnect, session trunking and pNFS enabled)storage as the datastore for PBS.

Ensure redunant network paths between PBS and ONTAP storage for high availability and performance. Consider link aggregation (LACP) for increased bandwidth and redundancy. Configure jumbo frames (MTU 9000) on all network devices to improve performance for storage traffic. When using NFS, create a dedicated export for PBS datastore with appropriate permissions. For block protocols, ensure proper zoning and LUN masking to restrict access to authorized PBS hosts only.

If using SCSI or NVMe-oF, create a LUN/Namespace on ONTAP and connect it to the PBS host. Format the LUN/Namespace with a suitable filesystem (e.g., ext4, xfs) and mount it on the PBS host. If using NFS, mount the NFS export on the PBS host. Utilize fstab or automount to ensure the datastore is mounted automatically on system reboot.

Once the storage is mounted, create a new datastore in PBS web interface by navigating to Datastore -> Add Datastore. Provide a name,select the datastore type as local and provide the mounted folder as Backing Path.

image::proxmox-wkld-dp-pbs-002.png[Local Datastore configuration in PBS]

== Datastore configuration with ONTAP S3 storage
S3 storage is typically used for offsite backup and long term retention. Proxmox Backup Server supports S3 storage as a Tech Preview feature. 

To configure ONTAP S3 storage as a datastore in PBS, follow these steps:

. Ensure that the ONTAP S3 service is enabled and properly configured.
. Create an S3 bucket on ONTAP to be used as the PBS datastore.
. Obtain the access key and secret key for the S3 bucket.
. Gather the S3 endpoint URL and certificate fingerprint information.
. In the PBS web interface, under configuration, navigate to S3 Endpoints and add a new S3 endpoint with the gathered information.
+
image::proxmox-wkld-dp-pbs-003.png[S3 Endpoint configuration in PBS]
+
image::proxmox-wkld-dp-pbs-004.png[S3 Endpoint configuration file in PBS]
+
. Next, navigate to Datastore -> Add Datastore. Provide a name, select the datastore type as S3, and select the configured S3 endpoint. Provide the folder name on local datastore to be used as local cache and select the bucket.
+
image::proxmox-wkld-dp-pbs-005.png[S3 Datastore configuration in PBS]
+
image::proxmox-wkld-dp-pbs-006.png[S3 Datastore configuration file in PBS]

== Local sync jobs to ONTAP S3 storage

To migrate data from local PBS datastore to ONTAP S3 storage, you can create a local sync job in PBS. This job will copy backup data from the local datastore to the S3 datastore for offsite storage and long-term retention.

To create a local sync job, follow these steps:

. In the PBS web interface, navigate to S3 Datastore -> Sync Jobs and click on Add.
+
image::proxmox-wkld-dp-pbs-007.png[Adding Local Sync Job in PBS]
+
. Select the location as Local, pick source local datastore, the desired namespace and depth. Configure the schedule for the sync job and any additional options as needed.
+
image::proxmox-wkld-dp-pbs-008.png[Local Sync Job configuration in PBS]
+
. Save the sync job configuration. The sync job will run according to the defined schedule and copy backup data from the local PBS datastore to the ONTAP S3 storage.

NOTE: For offsite storage and longer retention with ONTAP storage, Netapp Console can be utilized for management and data services.

== Adding Proxmox Backup Server to Proxmox VE Cluster

To add Proxmox Backup Server to a Proxmox VE cluster, follow these steps:

. In the Proxmox VE web interface, navigate to Datacenter -> Storage and click on Add -> Proxmox Backup Server.
. Provide a name for the PBS storage, enter the PBS server address, and provide the PBS datastore name and namespace.
+
image::proxmox-wkld-dp-pbs-009.png[Adding PBS storage in Proxmox VE]
+
. Provide PBS server certificate fingerprint for secure communication. Fingerprint can be obtained from PBS web interface or using the command on PBS: `proxmox-backup-manager cert info`.
+
image::proxmox-wkld-dp-pbs-010.png[PBS certificate fingerprint configuration in Proxmox Backup Server UI]
+
image::proxmox-wkld-dp-pbs-011.png[PBS certificate fingerprint configuration in Proxmox Backup Server CLI]
+
. Configure additional options such as backup retention policies and encryption as needed.
. Click on Add to save the PBS storage configuration.

Once added, the Proxmox VE cluster can utilize the PBS datastore for backup and restore operations for VMs and containers running on the cluster nodes.

== On-Demand Backup Operation

To perform an on-demand backup of a VM or container in Proxmox VE using Proxmox Backup Server, follow these steps:

. In the Proxmox VE web interface, navigate to the VM or container you want to back up.
. Click on the Backup tab and then click on Backup Now.
+
image::proxmox-wkld-dp-pbs-012.png[On-Demand Backup in Proxmox VE]
+
. Select Proxmox Backup Server Storage as the backup target.
+
image::proxmox-wkld-dp-pbs-013.png[On-Demand Backup selecting PBS target storage in Proxmox VE]
+
. Configure additional backup options such as compression, notification, and snapshot mode as needed.
. Click on Backup to initiate the backup process.

== Scheduled Backup Operation

To configure scheduled backups for VMs and containers in Proxmox VE using Proxmox Backup Server, follow these steps:

. In the Proxmox VE web interface, navigate to Datacenter -> Backup.
. Click on Add to create a new backup job.
+
image::proxmox-wkld-dp-pbs-014.png[Adding Scheduled Backup Job in Proxmox VE]
+
. Select the PBS storage as the target, and choose the desired backup schedule (e.g., daily, weekly). The selection mode can be set to All, Selected VMs/CTs to include/exclude, or Pool based.
+
image::proxmox-wkld-dp-pbs-015.png[Scheduled Backup Job configuration in Proxmox VE]
+
. Configure additional options such as retention policies, compression, and snapshot mode as needed.
. Click on Create to save the scheduled backup job configuration.

Once configured, the Proxmox VE cluster will automatically perform backups of the specified VMs and containers according to the defined schedule using Proxmox Backup Server as storage target. The scheduled job configuration is stored in /etc/pve/job.cfg file on Proxmox VE host.

image::proxmox-wkld-dp-pbs-016.png[Scheduled Backup Job configuration file in Proxmox VE]

== Proxmox VE host files backup to PBS

Proxmox VE hosts can also be backed up to Proxmox Backup Server. This includes configuration files, system settings, and other important data on the Proxmox VE host itself.

To back up a Proxmox VE host to PBS, follow these steps:

. In the Proxmox VE shell or SSH session, use the `proxmox-backup-client` command to create a backup of the host. For example:
+
```
proxmox-backup-client backup <backupspec> --repository <pbs-storage>:<datastore> --ns <namespace>
```
+
Replace `<backupspec>` with the desired backup specification (e.g., `backupname and backuptype/<directory or files to backup>`), `<pbs-storage>` with the FQDN name of the PBS, `<datastore>` with the PBS datastore name, and `<namespace>` with the desired namespace. Assuming authentication and fingerprint environment variables are available.
+
image::proxmox-wkld-dp-pbs-017.png[Proxmox VE host backup command]
+
. The backup process will create a backup of the Proxmox VE host and store it in the specified PBS datastore.
+
image::proxmox-wkld-dp-pbs-018.png[Viewing the files from Proxmox Backup Server UI]
+
. To restore the Proxmox VE host files from the backup, use the `proxmox-backup-client restore` command with the appropriate parameters.


== Pre and Post Backup Scripts

Proxmox VE allows the use of pre and post backup scripts to perform custom actions before and after the backup process. These scripts can be used to prepare the VM or container for backup, perform additional tasks, or clean up after the backup is complete.

To use pre and post backup scripts in Proxmox VE, follow these steps:

. Create the backup script on the Proxmox VE host. Ensure that the script is executable and have the necessary permissions. The following image shows the arguments that will be passed to the script on various events.
+
image::proxmox-wkld-dp-pbs-020.png[Script argument details for backup script]
+
. Ensure the backup job is available.
. In Proxmox VE shell or SSH session, use the `pvesh` command to set the  `--script` option to specify the script to be executed. For example:
+
image::proxmox-wkld-dp-pbs-019.png[Setting Backup Script in Proxmox VE]
+
. QEMU guest agents can also be used to quiesce the file system inside the workload before taking a snapshot for backup. Ensure that the QEMU guest agent is installed and running for this feature to work. The scripts need to be placed in /etc/qemu/fsfreeze-hook.d/ or /etc/qemu-ga/fsfreeze-hook.d/ inside the VM/CT.

NOTE: Hookscripts can also be set at the VM/CT level using the `qm set` or `pct set` commands with the `--hookscript` option. For sample hookscript, refer /usr/share/pve-docs/examples/guest-example-hookscript.pl on Proxmox VE host.

== Restoring with Proxmox VE

For existing VMs and containers, restoration can be performed directly from the Proxmox VE web interface. Navigate to the VM or container, click on the Backup tab, select the desired backup from PBS storage, and click on Restore.

image::proxmox-wkld-dp-pbs-021.png[Restoring VM from PBS in Proxmox VE]

For bare-metal recovery or restoring to a different Proxmox VE host, the `proxmox-backup-client` command can be used. 

When a VM or container is not available in Proxmox VE, you can navigate to PBS storage Backups section, select the desired backup, and click on Restore. Provide the target storage and other required information to complete the restoration process.

image::proxmox-wkld-dp-pbs-022.png[Restoring missing VM from PBS storage in Proxmox VE UI]

== Disaster Recovery with ONTAP SnapMirror

The PBS datastore on ONTAP storage can be replicated to another ONTAP system using SnapMirror for disaster recovery purposes. This ensures that backup data is protected and can be restored in case of a site failure.

After configuring SnapMirror replication, in the event of a disaster, you can mount the replicated PBS datastore on a secondary PBS instance. While adding the datastore in PBS, make sure to check the advanced option "Reuse existing datastore" to avoid reinitialization of the datastore.

image::proxmox-wkld-dp-pbs-023.png[Reusing existing datastore in PBS]

In case of ONTAP S3 storage, need to check both "Reuse existing datastore" and "Overwrite in-use marker" options while adding the datastore in PBS.

image::proxmox-wkld-dp-pbs-024.png[Reusing existing S3 datastore in PBS]

Once the datastore is added, you can access the backup data and perform restore operations as needed.

== Monitoring multiple Proxmox VE clusters and PBS with Proxmox Datacenter Manager

Multiple instances of Proxmox VE and Proxmox Backup Server can be monitored and managed using Proxmox Datacenter Manager (PDM). PDM provides a centralized management interface for monitoring the health, performance, and status of multiple Proxmox VE clusters and PBS instances.

image::proxmox-wkld-dp-pbs-025.png[Proxmox Datacenter Manager overview]

== Conclusion

Proxmox Backup Server integrated with NetApp ONTAP storage provides a robust and efficient data protection solution for Proxmox VE workloads. By leveraging ONTAP's advanced data management features and PBS's backup capabilities, organizations can ensure the availability and integrity of their virtualized workloads. This document serves as a guide for deploying and managing the integrated solution, enabling administrators to implement best practices for data protection in Proxmox VE environments.