---
sidebar: sidebar
permalink: proxmox/proxmox-wkld-dp-pbs.html
keywords: netapp, proxmox, proxmox ve, all-flash, nfs, iscsi, nvme, fc, ontap, storage, aff, asa, virtual machines, vm, containers, proxmox backup server
summary: "Protect Proxmox VE workloads using Proxmox Backup Server with NetApp ONTAP storage. This solution provides efficient backup and restore capabilities with incremental backups, deduplication, and disaster recovery using SnapMirror replication."
---
= Protect Proxmox VE workloads with Proxmox Backup Server and NetApp ONTAP
:hardbreaks:
:nofooter:
:icons: font
:linkattrs:
:imagesdir: ../media/

[.lead]
Protect Proxmox Virtual Environment (VE) workloads using Proxmox Backup Server (PBS) integrated with NetApp ONTAP storage. This solution provides efficient backup and restore capabilities with incremental backups, deduplication, compression, and disaster recovery using ONTAP SnapMirror replication.

== Solution architecture

The solution includes the following components:

* *Proxmox VE cluster* - Provides virtualization capabilities and manages virtual machines (VMs) and containers across multiple nodes.
* *Proxmox Backup Server* - Delivers dedicated backup and restore capabilities for Proxmox VE workloads with integration to ONTAP storage.
* *NetApp ONTAP storage* - Provides high-performance, scalable storage for the Proxmox VE cluster and PBS backup datastores.
* *Network infrastructure* - Ensures low-latency, high-throughput connectivity between Proxmox VE nodes, PBS, and ONTAP storage.
* *NetApp Console* - Offers centralized management for multiple NetApp storage systems and data services.

The following diagram shows the high-level architecture of the Proxmox Backup Server setup with ONTAP storage:

image::proxmox-wkld-dp-pbs-001.png[Proxmox VE Workload Data Protection with PBS and NetApp ONTAP Architecture]

== Proxmox Backup Server overview

Proxmox Backup Server (PBS) delivers enterprise backup capabilities designed for Proxmox Virtual Environment (VE). PBS provides efficient and reliable backup and restore operations for VMs and containers with features including incremental backups, deduplication, compression, and encryption.

=== Deployment considerations

Deploy PBS on bare metal or as a VM on Proxmox VE. When deploying PBS as a VM, consider the backup server availability if the Proxmox VE host experiences downtime. Deploy PBS on bare metal or on a separate Proxmox VE host or cluster to ensure backup server availability during primary host failures.

Backup contents are self-contained in the datastore, enabling datastore migration to another PBS instance if needed. This ensures backup data remains accessible even when the original PBS instance is unavailable.

=== Storage backend support

PBS supports various storage backends including local storage, NFS, iSCSI, FC, NVMe-oF, and S3 (Tech Preview). Integration with NetApp ONTAP storage enables organizations to leverage advanced data management features for enhanced data protection and recovery.

Use ONTAP SnapMirror to replicate the PBS datastore to another ONTAP system for disaster recovery. This protects backup data and enables restoration after site failures.

=== Multi-cluster management

A single PBS instance can manage multiple Proxmox VE clusters, providing centralized backup for large-scale deployments. Use namespaces to logically separate backup data for different clusters or tenants, ensuring data isolation and security.

Configure data retention policies to automatically manage backup data lifecycle and ensure compliance with organizational requirements. Set pruning policies to automatically mark old or unnecessary backup data for deletion. Garbage collection processes reclaim storage space by removing unused or obsolete data from the datastore.

=== Management interfaces

Manage PBS through a web-based interface, command-line tools, or REST API. Access the web interface at port 8007 using the URL `https://<pbs-ip-address>:8007`.

== Configure datastores with ONTAP file or block storage

PBS can use any folder mounted on local storage as a datastore. PBS stores catalog, index, and chunk files in the datastore. For optimal performance and scalability, use NetApp ONTAP SAN (iSCSI/FC/NVMe-oF) or NFS storage (with nConnect, session trunking, and pNFS enabled) as the PBS datastore.

=== Network configuration best practices

Ensure redundant network paths between PBS and ONTAP storage for high availability and performance. Consider link aggregation (LACP) for increased bandwidth and redundancy. Configure jumbo frames (MTU 9000) on all network devices to improve storage traffic performance.

For NFS, create a dedicated export for the PBS datastore with appropriate permissions. For block protocols, ensure proper zoning and LUN masking to restrict access to authorized PBS hosts only.

=== Storage preparation

For SAN or NVMe-oF protocols, create a LUN or namespace on ONTAP and connect it to the PBS host. Format the LUN or namespace with a suitable filesystem (ext4 or xfs) and mount it on the PBS host.

For NFS, mount the NFS export on the PBS host.

Use fstab or automount to ensure the datastore mounts automatically on system reboot.

=== Create the datastore in PBS

After mounting the storage, create a new datastore in the PBS web interface by navigating to Datastore > Add Datastore. Provide a name, select the datastore type as local, and provide the mounted folder as the backing path.

image::proxmox-wkld-dp-pbs-002.png[Local Datastore configuration in PBS]

== Configure datastores with ONTAP S3 storage

S3 storage is typically used for offsite backup and long-term retention. Proxmox Backup Server supports S3 storage as a Tech Preview feature.

. Ensure the ONTAP S3 service is enabled and properly configured.

. Create an S3 bucket on ONTAP for the PBS datastore.

. Obtain the access key and secret key for the S3 bucket.

. Gather the S3 endpoint URL and certificate fingerprint information.

. In the PBS web interface, navigate to Configuration > S3 Endpoints and add a new S3 endpoint with the gathered information.
+
image::proxmox-wkld-dp-pbs-003.png[S3 Endpoint configuration in PBS]
+
image::proxmox-wkld-dp-pbs-004.png[S3 Endpoint configuration file in PBS]
+
. Next, navigate to Datastore -> Add Datastore. Provide a name, select the datastore type as S3, and select the configured S3 endpoint. Provide the folder name on local datastore to be used as local cache and select the bucket.
+
image::proxmox-wkld-dp-pbs-005.png[S3 Datastore configuration in PBS]
+
image::proxmox-wkld-dp-pbs-006.png[S3 Datastore configuration file in PBS]

== Create local sync jobs to ONTAP S3 storage

Migrate data from the local PBS datastore to ONTAP S3 storage by creating a local sync job in PBS. This job copies backup data from the local datastore to the S3 datastore for offsite storage and long-term retention.

. In the PBS web interface, navigate to S3 Datastore > Sync Jobs and click Add.
+
image::proxmox-wkld-dp-pbs-007.png[Adding Local Sync Job in PBS]
+
. Select the location as Local, pick source local datastore, the desired namespace and depth. Configure the schedule for the sync job and any additional options as needed.
+
image::proxmox-wkld-dp-pbs-008.png[Local Sync Job configuration in PBS]
+
. Save the sync job configuration. The sync job will run according to the defined schedule and copy backup data from the local PBS datastore to the ONTAP S3 storage.

NOTE: For offsite storage and longer retention with ONTAP storage, Netapp Console can be utilized for management and data services.

== Adding Proxmox Backup Server to Proxmox VE Cluster

To add Proxmox Backup Server to a Proxmox VE cluster, follow these steps:

. In the Proxmox VE web interface, navigate to Datacenter -> Storage and click on Add -> Proxmox Backup Server.
. Provide a name for the PBS storage, enter the PBS server address, and provide the PBS datastore name and namespace.
+
image::proxmox-wkld-dp-pbs-009.png[Adding PBS storage in Proxmox VE]
+
. Provide PBS server certificate fingerprint for secure communication. Fingerprint can be obtained from PBS web interface or using the command on PBS: `proxmox-backup-manager cert info`.
+
image::proxmox-wkld-dp-pbs-010.png[PBS certificate fingerprint configuration in Proxmox Backup Server UI]
+
image::proxmox-wkld-dp-pbs-011.png[PBS certificate fingerprint configuration in Proxmox Backup Server CLI]
+
. Configure additional options such as backup retention policies and encryption as needed.
. Click on Add to save the PBS storage configuration.

Once added, the Proxmox VE cluster can utilize the PBS datastore for backup and restore operations for VMs and containers running on the cluster nodes.

== Perform on-demand backups

Create an immediate backup of a VM or container in Proxmox VE using Proxmox Backup Server.

. In the Proxmox VE web interface, navigate to the VM or container to back up.

. Click the Backup tab and then click Backup Now.
+
image::proxmox-wkld-dp-pbs-012.png[On-Demand Backup in Proxmox VE]
+
. Select Proxmox Backup Server Storage as the backup target.
+
image::proxmox-wkld-dp-pbs-013.png[On-Demand Backup selecting PBS target storage in Proxmox VE]
+
. Configure additional backup options such as compression, notification, and snapshot mode as needed.
. Click on Backup to initiate the backup process.

== Configure scheduled backups

Create scheduled backups for VMs and containers in Proxmox VE using Proxmox Backup Server.

. In the Proxmox VE web interface, navigate to Datacenter > Backup.

. Click Add to create a new backup job.
+
image::proxmox-wkld-dp-pbs-014.png[Adding Scheduled Backup Job in Proxmox VE]
+
. Select the PBS storage as the target, and choose the desired backup schedule (e.g., daily, weekly). The selection mode can be set to All, Selected VMs/CTs to include/exclude, or Pool based.
+
image::proxmox-wkld-dp-pbs-015.png[Scheduled Backup Job configuration in Proxmox VE]
+
. Configure additional options such as retention policies, compression, and snapshot mode as needed.
. Click on Create to save the scheduled backup job configuration.

Once configured, the Proxmox VE cluster will automatically perform backups of the specified VMs and containers according to the defined schedule using Proxmox Backup Server as storage target. The scheduled job configuration is stored in /etc/pve/job.cfg file on Proxmox VE host.

image::proxmox-wkld-dp-pbs-016.png[Scheduled Backup Job configuration file in Proxmox VE]

== Back up Proxmox VE host files to PBS

Back up Proxmox VE host configuration files, system settings, and other important data to Proxmox Backup Server.

. In a Proxmox VE shell or SSH session, use the `proxmox-backup-client` command to create a host backup. For example:
+
```
proxmox-backup-client backup <backupspec> --repository <pbs-storage>:<datastore> --ns <namespace>
```
+
Replace `<backupspec>` with the desired backup specification (e.g., `backupname and backuptype/<directory or files to backup>`), `<pbs-storage>` with the FQDN name of the PBS, `<datastore>` with the PBS datastore name, and `<namespace>` with the desired namespace. Assuming authentication and fingerprint environment variables are available.
+
image::proxmox-wkld-dp-pbs-017.png[Proxmox VE host backup command]
+
. The backup process will create a backup of the Proxmox VE host and store it in the specified PBS datastore.
+
image::proxmox-wkld-dp-pbs-018.png[Viewing the files from Proxmox Backup Server UI]
+
. To restore the Proxmox VE host files from the backup, use the `proxmox-backup-client restore` command with the appropriate parameters.


== Use pre and post backup scripts

Proxmox VE supports pre and post backup scripts to perform custom actions before and after the backup process. Use these scripts to prepare VMs or containers for backup, perform additional tasks, or clean up after backup completion.

. Create the backup script on the Proxmox VE host. Ensure the script is executable and has the necessary permissions. The following image shows the arguments passed to the script on various events.
+
image::proxmox-wkld-dp-pbs-020.png[Script argument details for backup script]
+
. Ensure the backup job is available.
. In Proxmox VE shell or SSH session, use the `pvesh` command to set the  `--script` option to specify the script to be executed. For example:
+
image::proxmox-wkld-dp-pbs-019.png[Setting Backup Script in Proxmox VE]
+
. QEMU guest agents can also be used to quiesce the file system inside the workload before taking a snapshot for backup. Ensure that the QEMU guest agent is installed and running for this feature to work. The scripts need to be placed in /etc/qemu/fsfreeze-hook.d/ or /etc/qemu-ga/fsfreeze-hook.d/ inside the VM/CT.

NOTE: Hookscripts can also be set at the VM/CT level using the `qm set` or `pct set` commands with the `--hookscript` option. For sample hookscript, refer /usr/share/pve-docs/examples/guest-example-hookscript.pl on Proxmox VE host.

== Restore VMs and containers

Restore existing VMs and containers directly from the Proxmox VE web interface. Navigate to the VM or container, click the Backup tab, select the desired backup from PBS storage, and click Restore.

image::proxmox-wkld-dp-pbs-021.png[Restoring VM from PBS in Proxmox VE]

For bare-metal recovery or restoring to a different Proxmox VE host, the `proxmox-backup-client` command can be used. 

When a VM or container is not available in Proxmox VE, you can navigate to PBS storage Backups section, select the desired backup, and click on Restore. Provide the target storage and other required information to complete the restoration process.

image::proxmox-wkld-dp-pbs-022.png[Restoring missing VM from PBS storage in Proxmox VE UI]

== Configure disaster recovery with ONTAP SnapMirror

Replicate the PBS datastore on ONTAP storage to another ONTAP system using SnapMirror for disaster recovery. This protects backup data and enables restoration after site failures.

After configuring SnapMirror replication, mount the replicated PBS datastore on a secondary PBS instance in the event of a disaster. When adding the datastore in PBS, check the advanced option "Reuse existing datastore" to avoid datastore reinitialization.

image::proxmox-wkld-dp-pbs-023.png[Reusing existing datastore in PBS]

In case of ONTAP S3 storage, need to check both "Reuse existing datastore" and "Overwrite in-use marker" options while adding the datastore in PBS.

image::proxmox-wkld-dp-pbs-024.png[Reusing existing S3 datastore in PBS]

Once the datastore is added, you can access the backup data and perform restore operations as needed.

== Monitor multiple clusters with Proxmox Datacenter Manager

Monitor and manage multiple Proxmox VE and Proxmox Backup Server instances using Proxmox Datacenter Manager (PDM). PDM provides a centralized management interface for monitoring the health, performance, and status of multiple Proxmox VE clusters and PBS instances.

image::proxmox-wkld-dp-pbs-025.png[Proxmox Datacenter Manager overview]

== Summary

Proxmox Backup Server integrated with NetApp ONTAP storage delivers robust and efficient data protection for Proxmox VE workloads. Organizations can ensure virtualized workload availability and integrity by leveraging ONTAP's advanced data management features and PBS's backup capabilities. Use this guide to deploy and manage the integrated solution with data protection best practices for Proxmox VE environments.